{% extends 'base.html' %}
{% block content %}

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="metric-label">Debt Monster Balance</div>
            <div class="metric-value text-danger">${{ "%.2f"|format(summary.total_debt) }}</div>
            <small class="text-muted">Weighted APR: {{ "%.2f"|format(summary.weighted_apr) }}%</small>
        </div>
    </div>

    <div class="col-md-4">
        <div class="stat-card">
            <div class="metric-label">DTI (Financial Health)</div>
            <div class="metric-value {{ 'text-danger' if summary.dti > 36 else 'text-info' }}">{{ "%.1f"|format(summary.dti) }}%</div>
            <small class="text-muted">Goal: Stay below 36%</small>
        </div>
    </div>

    <div class="col-md-4">
        <div class="stat-card">
            <div class="metric-label">Monthly "Attack Power"</div>
            <div class="metric-value text-success">${{ "%.2f"|format(summary.extra_monthly) }}</div>
            <small class="text-muted">Used for Snowball/Avalanche sim</small>
        </div>
    </div>
</div>

<div class="stat-card mb-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
            <h5 class="fw-bold m-0">Strategy Controls</h5>
            <div class="small fw-medium" style="color:#d1d5db;">
                Override attack amount or use your free cashflow automatically.
            </div>
        </div>

        <form class="d-flex flex-wrap gap-2 align-items-center" action="{{ url_for('set_strategy') }}" method="POST">
            <select name="method" class="form-select" style="min-width: 180px;">
                <option value="avalanche" {{ 'selected' if summary.strategy_method == 'avalanche' else '' }}>Avalanche (Highest APR)</option>
                <option value="snowball" {{ 'selected' if summary.strategy_method == 'snowball' else '' }}>Snowball (Smallest Balance)</option>
            </select>

            <input name="extra_override" type="number" step="0.01" class="form-control"
                   placeholder="Override $/mo (blank = auto)">
            <button class="btn btn-primary">Apply</button>
        </form>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold m-0 text-primary">Avalanche Forecast</h5>
                <span class="badge bg-secondary">Math-optimal</span>
            </div>
            <div class="metric-value">{{ summary.ava.months }} months</div>
            <div class="text-muted">
                {% if summary.ava.date %}
                    Debt-free: <span class="text-white fw-bold">{{ summary.ava.date.strftime('%m/%d/%Y') }}</span>
                {% else %}
                    Debt-free: <span class="text-danger fw-bold">Not reachable (payments too low)</span>
                {% endif %}
            </div>
            <div class="text-muted">Interest paid: <span class="text-white fw-bold">
                {% if summary.ava_unreachable %}∞{% else %}${{ "%.0f"|format(summary.ava.interest) }}{% endif %}
            </span></div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold m-0 text-info">Snowball Forecast</h5>
                <span class="badge bg-secondary">Motivation-optimal</span>
            </div>
            <div class="metric-value">{{ summary.snb.months }} months</div>
            <div class="text-muted">
                {% if summary.snb.date %}
                    Debt-free: <span class="text-white fw-bold">{{ summary.snb.date.strftime('%m/%d/%Y') }}</span>
                {% else %}
                    Debt-free: <span class="text-danger fw-bold">Not reachable (payments too low)</span>
                {% endif %}
            </div>
            <div class="text-muted">Interest paid: <span class="text-white fw-bold">
                {% if summary.snb_unreachable %}∞{% else %}${{ "%.0f"|format(summary.snb.interest) }}{% endif %}
            </span></div>
        </div>
    </div>
</div>

<h4 class="fw-bold mb-4">The Cashflow Schedule</h4>
{% for group in groups %}
<div class="stat-card mb-4 pay-group-{{ loop.index % 3 + 1 }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold m-0 text-primary">Check Date: {{ group.date.strftime('%m/%d/%Y') }}</h5>
        <span class="remainder-pill">Left to Attack Debt: ${{ "%.2f"|format(group.remainder) }}</span>
    </div>

    <table class="table table-dark table-sm border-0 m-0">
        <thead>
            <tr class="label">
                <th>DUE DATE</th>
                <th>EXPENSE</th>
                <th class="text-end">AMOUNT</th>
            </tr>
        </thead>
        <tbody>
            {% for b in group.bills %}
            <tr>
                <td>{{ b.due_date.strftime('%m/%d') }}</td>
                <td>{{ b.name }}</td>
                <td class="text-end text-danger">-${{ "%.2f"|format(b.amount) }}</td>
            </tr>
            {% endfor %}
            <tr class="border-top border-secondary">
                <td colspan="2" class="text-muted small">Check Amount: +${{ "%.2f"|format(group.income) }}</td>
                <td class="text-end fw-bold">Check Remainder: ${{ "%.2f"|format(group.remainder) }}</td>
            </tr>
        </tbody>
    </table>
</div>
{% endfor %}

{% endblock %}
