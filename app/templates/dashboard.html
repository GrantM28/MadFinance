{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <h2 class="fw-bold mb-1">Monthly Planner</h2>
    <div class="text-muted">Bills + minimum debt payments across paychecks. Like your Excel sheet, but not painful.</div>
  </div>

  <div class="d-flex gap-2 align-items-center">
    <button class="btn btn-outline-custom" type="button" data-bs-toggle="collapse" data-bs-target="#strategyPanel">
      <i class="bi bi-sliders me-1"></i> Strategy (optional)
    </button>
  </div>
</div>

<!-- Top summary row (Excel "Totals") -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Monthly Income</div>
      <div class="metric-value text-info">${{ "%.0f"|format(summary.income) }}</div>
      <small class="text-muted">All sources normalized monthly</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Bills</div>
      <div class="metric-value text-danger">${{ "%.0f"|format(summary.bills) }}</div>
      <small class="text-muted">Fixed obligations</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Debt Minimums</div>
      <div class="metric-value text-warning">${{ "%.0f"|format(summary.debt_min) }}</div>
      <small class="text-muted">Monthly minimum payments</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Leftover</div>
      <div class="metric-value {{ 'text-danger' if summary.cashflow < 0 else 'text-success' }}">
        ${{ "%.0f"|format(summary.cashflow) }}
      </div>
      <small class="text-muted">After bills + minimums</small>
    </div>
  </div>
</div>

<!-- Optional Strategy Controls (collapsed) -->
<div class="collapse mb-4" id="strategyPanel">
  <div class="stat-card">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h5 class="fw-bold m-0">Debt Strategy (Optional)</h5>
        <div class="small" style="color:#d1d5db;">
          This doesn’t change your planner. It only affects payoff projections.
        </div>
      </div>

      <form class="d-flex flex-wrap gap-2 align-items-center" action="{{ url_for('set_strategy') }}" method="POST">
        <select name="method" class="form-select" style="min-width: 200px;">
          <option value="avalanche" {{ 'selected' if summary.strategy_method == 'avalanche' else '' }}>Avalanche (Highest APR)</option>
          <option value="snowball" {{ 'selected' if summary.strategy_method == 'snowball' else '' }}>Snowball (Smallest Balance)</option>
        </select>

        <input name="extra_override" type="number" step="0.01" class="form-control"
               placeholder="Extra $/mo (blank = leftover)" style="min-width: 260px;">
        <button class="btn btn-primary">Apply</button>
      </form>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-6">
        <div class="mini-card">
          <div class="mini-title text-primary">Avalanche</div>
          <div class="mini-metric">{{ summary.ava.months }} months</div>
          <div class="mini-sub">
            {% if summary.ava.date %}Debt-free: {{ summary.ava.date.strftime('%m/%d/%Y') }}{% else %}Debt-free: —{% endif %}
            • Interest: {% if summary.ava_unreachable %}∞{% else %}${{ "%.0f"|format(summary.ava.interest) }}{% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="mini-card">
          <div class="mini-title text-info">Snowball</div>
          <div class="mini-metric">{{ summary.snb.months }} months</div>
          <div class="mini-sub">
            {% if summary.snb.date %}Debt-free: {{ summary.snb.date.strftime('%m/%d/%Y') }}{% else %}Debt-free: —{% endif %}
            • Interest: {% if summary.snb_unreachable %}∞{% else %}${{ "%.0f"|format(summary.snb.interest) }}{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main: Left = Planner table, Right = Charts -->
<div class="row g-4">
  <!-- Planner -->
  <div class="col-lg-7">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h5 class="fw-bold m-0">Paycheck Plan</h5>
        <span class="badge bg-secondary">Group by pay period</span>
      </div>

      {% if groups|length == 0 %}
        <div class="text-muted">
          Add Income sources with “Next Pay Date” so the planner can build paycheck windows.
        </div>
      {% endif %}

      {% for g in groups %}
      <div class="planner-block mb-4">
        <div class="planner-head d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="planner-title">
            <span class="text-primary fw-bold">Check Date:</span>
            <span class="fw-bold">{{ g.date.strftime('%m/%d/%Y') }}</span>
            <span class="text-muted ms-2">Income: ${{ "%.2f"|format(g.income) }}</span>
          </div>

          <span class="remainder-pill">
            Left after bills + debt mins: ${{ "%.2f"|format(g.remainder) }}
          </span>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-dark table-hover table-sm align-middle m-0">
            <thead>
              <tr class="text-muted small">
                <th style="width:140px;">DUE</th>
                <th>ITEM</th>
                <th class="text-end" style="width:140px;">AMOUNT</th>
              </tr>
            </thead>
            <tbody>
              {% for b in g.bills %}
              <tr>
                <td class="text-muted">{% if b.due_date %}{{ b.due_date.strftime('%m/%d/%Y') }}{% else %}—{% endif %}</td>
                <td class="fw-semibold">{{ b.name }}</td>
                <td class="text-end text-danger">-${{ "%.2f"|format(b.amount) }}</td>
              </tr>
              {% endfor %}

              <tr class="border-top border-secondary">
                <td class="text-muted small" colspan="2">Bills total</td>
                <td class="text-end fw-bold">-${{ "%.2f"|format(g.bill_total) }}</td>
              </tr>

              <tr>
                <td class="text-muted small" colspan="2">Debt minimum share (split across checks)</td>
                <td class="text-end fw-bold text-warning">-${{ "%.2f"|format(g.debt_min) }}</td>
              </tr>

              <tr class="border-top border-secondary">
                <td class="text-muted small" colspan="2">Remainder</td>
                <td class="text-end fw-bold">{{ "$%.2f"|format(g.remainder) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Charts -->
  <div class="col-lg-5">
    <div class="stat-card mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-bold">DTI</div>
        <span class="badge bg-secondary">Monthly</span>
      </div>
      <canvas id="dtiChart" height="220"></canvas>
      <div class="text-muted small mt-2">
        DTI: <span class="fw-bold">{{ "%.1f"|format(summary.dti) }}%</span>
        • Obligations: ${{ "%.0f"|format(summary.obligations) }}
      </div>
    </div>

    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-bold">Debt Balances</div>
        <span class="badge bg-secondary">Now</span>
      </div>
      <canvas id="debtBarChart" height="240"></canvas>
      <div class="text-muted small mt-2">
        Total debt: <span class="fw-bold">${{ "%.0f"|format(summary.total_debt) }}</span>
        • Weighted APR: <span class="fw-bold">{{ "%.2f"|format(summary.weighted_apr) }}%</span>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const debts = [
    {% for d in debts %}
      { name: "{{ d.name|e }}", balance: {{ "%.2f"|format(d.balance) }}, apr: {{ "%.2f"|format(d.interest_rate) }} },
    {% endfor %}
  ];

  const obligations = {{ "%.2f"|format(summary.obligations) }};
  const freeCashflow = {{ "%.2f"|format(summary.cashflow) }};

  initDtiChart(obligations, Math.max(freeCashflow, 0));
  initDebtBarChart(debts);
</script>
{% endblock %}
