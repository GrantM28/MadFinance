{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <h2 class="fw-bold mb-1">Dashboard</h2>
    <div class="text-muted">Totals, charts, and payoff strategy. Schedule lives in Monthly Schedule.</div>
  </div>

  <button class="btn btn-outline-custom" type="button" data-bs-toggle="collapse" data-bs-target="#strategyPanel">
    <i class="bi bi-sliders me-1"></i> Strategy Controls
  </button>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Monthly Income</div>
      <div class="metric-value text-info">${{ "%.0f"|format(summary.monthly_income) }}</div>
      <small class="text-muted">Normalized monthly</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Total Debt</div>
      <div class="metric-value text-danger">${{ "%.0f"|format(summary.total_debt) }}</div>
      <small class="text-muted">Weighted APR: {{ "%.2f"|format(summary.weighted_apr) }}%</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Cashflow Burden</div>
      <div class="metric-value {{ 'text-danger' if summary.cashflow_burden_pct > 60 else 'text-info' }}">
        {{ "%.1f"|format(summary.cashflow_burden_pct) }}%
      </div>
      <small class="text-muted">Bills + debt mins / income</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card">
      <div class="metric-label">Lender DTI</div>
      <div class="metric-value {{ 'text-danger' if summary.lender_dti_pct > 36 else 'text-info' }}">
        {{ "%.1f"|format(summary.lender_dti_pct) }}%
      </div>
      <small class="text-muted">Debt mins / income</small>
    </div>
  </div>
</div>

<div class="collapse mb-4" id="strategyPanel">
  <div class="stat-card">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h5 class="fw-bold m-0">Payoff Strategy</h5>
        <div class="small" style="color:#d1d5db;">Extra “attack power” defaults to leftover cashflow.</div>
      </div>

      <form class="d-flex flex-wrap gap-2 align-items-center" action="{{ url_for('set_strategy_route') }}" method="POST">
        <select name="method" class="form-select" style="min-width: 200px;">
          <option value="avalanche" {{ 'selected' if summary.strategy_method == 'avalanche' else '' }}>Avalanche (Highest APR)</option>
          <option value="snowball" {{ 'selected' if summary.strategy_method == 'snowball' else '' }}>Snowball (Smallest Balance)</option>
        </select>

        <input name="extra_override" type="number" step="0.01" class="form-control"
               placeholder="Extra $/mo (blank = leftover)" style="min-width: 260px;">
        <button class="btn btn-primary">Apply</button>
      </form>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-6">
        <div class="mini-card">
          <div class="mini-title text-primary">Avalanche</div>
          <div class="mini-metric">{{ summary.ava.months }} months</div>
          <div class="mini-sub">
            {% if summary.ava.date %}Debt-free: {{ summary.ava.date.strftime('%m/%d/%Y') }}{% else %}Debt-free: —{% endif %}
            • Interest: {% if summary.ava_unreachable %}∞{% else %}${{ "%.0f"|format(summary.ava.interest) }}{% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="mini-card">
          <div class="mini-title text-info">Snowball</div>
          <div class="mini-metric">{{ summary.snb.months }} months</div>
          <div class="mini-sub">
            {% if summary.snb.date %}Debt-free: {{ summary.snb.date.strftime('%m/%d/%Y') }}{% else %}Debt-free: —{% endif %}
            • Interest: {% if summary.snb_unreachable %}∞{% else %}${{ "%.0f"|format(summary.snb.interest) }}{% endif %}
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-bold">Obligations vs Free</div>
        <span class="badge bg-secondary">Monthly</span>
      </div>
      <canvas id="dtiChart" height="220"></canvas>
      <div class="text-muted small mt-2">
        Obligations: ${{ "%.0f"|format(summary.obligations) }} • Free: ${{ "%.0f"|format(summary.cashflow) }}
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="stat-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-bold">Debt Balances</div>
        <span class="badge bg-secondary">Now</span>
      </div>
      <canvas id="debtBarChart" height="220"></canvas>
      <div class="text-muted small mt-2">Balances by account.</div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const obligations = {{ "%.2f"|format(summary.obligations) }};
  const freeCashflow = {{ "%.2f"|format(summary.cashflow) }};

  const debtChart = {{ debt_chart|tojson }};

  initDtiChart(obligations, Math.max(freeCashflow, 0));
  initDebtBarChart(debtChart);
</script>
{% endblock %}
