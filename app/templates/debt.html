{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
        <h2 class="fw-bold mb-1"><i class="bi bi-credit-card-2-front text-danger"></i> Debt Management</h2>
        <div class="text-muted">Add debts once, then let the dashboard simulate payoff strategies.</div>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-custom">
        <i class="bi bi-graph-up-arrow me-1"></i> View Strategy Forecast
    </a>
</div>

{# Quick summary math in-template (simple, fine for small datasets) #}
{% set total_debt = (debts | sum(attribute='balance')) %}
{% set total_min = (debts | sum(attribute='min_payment')) %}
{% set weighted_apr = 0 %}
{% if total_debt > 0 %}
    {% for d in debts %}
        {% set weighted_apr = weighted_apr + (d.balance / total_debt) * d.interest_rate %}
    {% endfor %}
{% endif %}

{% set highest_apr = None %}
{% set smallest_bal = None %}
{% for d in debts %}
    {% if highest_apr is none or d.interest_rate > highest_apr.interest_rate %}
        {% set highest_apr = d %}
    {% endif %}
    {% if smallest_bal is none or d.balance < smallest_bal.balance %}
        {% set smallest_bal = d %}
    {% endif %}
{% endfor %}

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="metric-label">Total Debt</div>
            <div class="metric-value text-danger">${{ "%.2f"|format(total_debt) }}</div>
            <div class="text-muted small">Across {{ debts|length }} accounts</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="metric-label">Total Minimums</div>
            <div class="metric-value text-info">${{ "%.2f"|format(total_min) }}</div>
            <div class="text-muted small">Monthly minimum payments</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="metric-label">Weighted APR</div>
            <div class="metric-value">{{ "%.2f"|format(weighted_apr) }}%</div>
            <div class="text-muted small">
                {% if highest_apr %}
                    Highest APR: <span class="text-white fw-bold">{{ highest_apr.name }}</span>
                {% else %}
                    Add a debt account to see priority hints
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if highest_apr and smallest_bal %}
<div class="stat-card mb-4">
    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
        <div>
            <div class="metric-label">Payoff Hints</div>
            <div class="text-muted">Avalanche targets APR first. Snowball targets smallest balance first.</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-secondary">
                <i class="bi bi-fire me-1"></i> Avalanche Target: {{ highest_apr.name }} ({{ highest_apr.interest_rate }}%)
            </span>
            <span class="badge bg-secondary">
                <i class="bi bi-snow me-1"></i> Snowball Target: {{ smallest_bal.name }} (${{ "%.0f"|format(smallest_bal.balance) }})
            </span>
        </div>
    </div>
</div>
{% endif %}

<div class="row g-4">
    <div class="col-md-4">
        <div class="stat-card">
            <h5 class="mb-3 fw-bold">Add Debt Account</h5>
            <form action="{{ url_for('manage_debt') }}" method="POST">
                <div class="mb-2">
                    <label class="small text-muted">NAME</label>
                    <input type="text" name="name" class="form-control" placeholder="e.g. Chase Freedom" required>
                </div>
                <div class="mb-2">
                    <label class="small text-muted">BALANCE</label>
                    <input type="number" step="0.01" name="balance" class="form-control" placeholder="0.00" required>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="small text-muted">APR %</label>
                        <input type="number" step="0.01" name="apr" class="form-control" placeholder="e.g. 29.99" required>
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">MIN PAY</label>
                        <input type="number" step="0.01" name="min_pay" class="form-control" placeholder="e.g. 45.00" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-plus-circle me-1"></i> Register Debt
                </button>
            </form>
        </div>
    </div>

    <div class="col-md-8">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <h5 class="fw-bold m-0">Debt Accounts</h5>
                <span class="text-muted small">Tip: Keep APR accurate — that’s what drives the forecast.</span>
            </div>

            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr class="text-muted small">
                        <th>NAME</th>
                        <th>BALANCE</th>
                        <th>APR</th>
                        <th>MIN PAY</th>
                        <th class="text-end">ACTION</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in debts %}
                    <tr>
                        <td class="fw-bold">{{ d.name }}</td>
                        <td>${{ "%.2f"|format(d.balance) }}</td>
                        <td>
                            <span class="badge {{ 'bg-danger' if d.interest_rate >= 20 else 'bg-secondary' }}">
                                {{ "%.2f"|format(d.interest_rate) }}%
                            </span>
                        </td>
                        <td>${{ "%.2f"|format(d.min_payment) }}</td>
                        <td class="text-end">
                            <a href="{{ url_for('delete_item', category='debt', id=d.id) }}"
                               class="btn btn-sm btn-outline-danger border-0" title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-muted">
                            No debts yet — add one on the left, then go to the Dashboard to see payoff forecasts.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
</div>
{% endblock %}
